import os
configfile: "config.yaml"

def ReturnBarcodeFolderNames():
    path = config['results_folder'] + "Barcode/.tempOutput"
    directory_names = []
    for root, directory, files in os.walk(path):
        for direc in directory:
            directory_names.append(direc)
    return directory_names

FAST5_FILES, = glob_wildcards(config['results_folder'] + "DataFiles/fast5/{fast5_files}.fast5")

rule all:
    input:
        expand(config['results_folder'] + "Basecall/{fast5_files}", fast5_files=FAST5_FILES),
        config['results_folder'] + "Barcode/.tempOutput/",
        expand(config['results_folder'] + "Barcode/{barcode_folder}.merged.fastq", barcode_folder=ReturnBarcodeFolderNames())

rule basecall:
    input:
         config['results_folder'] + "DataFiles/fast5/{fast5_files}.fast5"
    output:
        directory(config['results_folder'] + "Basecall/{fast5_files}")
    shell:
         r"""
         ls {input} \
         | \
         guppy_basecaller \
         --quiet \
         --save_path {output} \
         --config dna_r9.4.1_450bps_fast.cfg \
         --num_callers 2 \
         --cpu_threads_per_caller 6
         """

checkpoint barcode:
    input:
        expand(config['results_folder'] + "Basecall/{fast5_files}", fast5_files=FAST5_FILES)
    output:
        temp(directory(config['results_folder'] + "Barcode/.tempOutput/"))
    shell:
         r"""
         guppy_barcoder \
        --input_path {input} \
        --save_path {output} \
        --barcode_kits EXP-PBC096 \
        --recursive
         """

def aggregate_barcode_folders_for_merging(wildcards):
    """
    Collect barcode folder paths
    """

    checkpoint_output = checkpoints.barcode.get(**wildcards).output[0]
    folder_names = []
    # iterate through each item in our output
    for root, directories, files in os.walk(checkpoint_output):
        # iterate through each directory in the output
        for direc in directories:
            # append the directory to our folder names
            folder_names.append(direc)
    # return a list of folder paths under the Barcode/.tempOutput folder
    return expand(config['results_folder'] + "Barcode/.tempOutput/{barcode_folder}", barcode_folder=folder_names)


rule merge:
    input:
        aggregate_barcode_folders_for_merging
    output:
        config['results_folder'] + "Barcode/{barcode_folder}.merged.fastq"
    params:
        temp_folder = config['results_folder'] + "Barcode/.tempOutput",
        output_folder = config['results_folder'] + "Barcode"
    shell:
         r"""
         mv \
         {params.temp_folder}/{wildcards.barcode_folder}/*.fastq \
         {params.output_folder}/{wildcards.barcode_folder}.merged.fastq
         """
