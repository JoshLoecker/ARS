import os
from pathlib import Path

configfile: "config.yaml"


TEMP_BARCODE_FOLDER = config['results_folder']
FAST5_FILES, = glob_wildcards(config['results_folder'] + "DataFiles/fast5/{fast5_files}.fast5")
BARCODE_FOLDER = os.listdir(config['results_folder'] + ".")

def aggregate_barcode_folder_names(wildcards):
    checkpoint_output = checkpoints.barcode.get().output[0]
    folder_names = []
    for item in os.scandir(checkpoint_output):
        if Path(item).is_dir():
            folder_names.append(item)
    return expand(config['results_folder'] + "Barcode/{folder}.merged.fastq", folder=folder_names)


rule all:
    input:
        expand(config['results_folder'] + "Basecall/{fast5_file}", fast5_file=FAST5_FILES),
        aggregate_barcode_folder_names

rule basecall:
    input:
         config['results_folder'] + "DataFiles/fast5/{fast5_file}.fast5"
    output:
        directory(config['results_folder'] + "Basecall/{fast5_file}")
    shell:
         r"""
         ls {input} \
         | \
         guppy_basecaller \
         --save_path {output} \
         --quiet \
         --config dna_r9.4.1_450bps_fast.cfg \
         --num_callers 2 \
         --cpu_threads_per_caller 6
         """

checkpoint barcode:
    input:
        config['results_folder'] + "Basecall/"
    output:
        temp(directory(config['results_folder'] + ".barcodeTempOutput/"))
    shell:
         r"""
         guppy_barcoder \
        --input_path {input} \
        --save_path {output} \
        --barcode_kits EXP-PBC096 \
        --recursive
         """

rule merge_files:
    input:
        config['results_folder'] + ".barcodeTempOutput/{folder}"
    output:
        config['results_folder'] + "Barcode/{folder}.merged.fastq"
    shell:
        "echo {input}"

